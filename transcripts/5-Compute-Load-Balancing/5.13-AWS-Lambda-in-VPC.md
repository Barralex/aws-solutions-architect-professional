# 5.13 AWS Lambda - in VPC

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 5 - Compute & Load Balancing
**Duración:** ~8 min

---

## Resumen

Lambda por defecto tiene internet pero no accede a recursos privados (RDS). En VPC: tiene acceso a recursos privados pero pierde internet (necesita NAT Gateway). Para IP fija: Lambda en VPC + NAT con Elastic IP. Invocaciones: sync (API GW, SDK) vs async (S3, SNS, EventBridge).

---

## Lambda por defecto vs en VPC

### Por defecto (sin VPC)
```
Lambda ──► Internet ✅
Lambda ──► DynamoDB (public API) ✅
Lambda ──► RDS en private subnet ❌
```

### En VPC
```
Lambda ──► RDS en private subnet ✅
Lambda ──► Internet ❌ (necesita NAT)
Lambda ──► DynamoDB ❌ (necesita NAT o VPC Endpoint)
```

---

## Lambda en VPC que necesita internet

```
┌─────────────────────────────────────────────────────┐
│  VPC                                                │
│  ┌─────────────────┐    ┌─────────────────┐        │
│  │ Private Subnet  │    │ Public Subnet   │        │
│  │                 │    │                 │        │
│  │   [Lambda]      │    │  [NAT Gateway]  │        │
│  │       │         │    │       │         │        │
│  │       └─────────┼────┼───────┘         │        │
│  │                 │    │       │         │        │
│  └─────────────────┘    └───────┼─────────┘        │
│                                 │                   │
└─────────────────────────────────┼───────────────────┘
                                  │
                          [Internet Gateway]
                                  │
                              Internet
```

**IMPORTANTE:** Lambda en PUBLIC subnet NO tiene internet. Solo funciona en PRIVATE subnet + NAT.

---

## IP Fija para Lambda

**Problema:** Lambda sin VPC tiene IP random. Tu API quiere filtrar por IP.

**Solución:**
```
Lambda (private subnet)
    → NAT Gateway (con Elastic IP fijo)
    → Internet Gateway
    → Tu API ve siempre la misma IP
```

---

## Invocaciones: Sync vs Async

### Synchronous (esperás respuesta)
- CLI, SDK, API Gateway
- Error handling en el cliente
- Retries los hace el cliente

```
Cliente → Lambda → Respuesta inmediata
```

### Asynchronous (fire & forget)
- S3, SNS, EventBridge
- Lambda hace hasta 3 retries automáticos
- Si falla → DLQ (Dead Letter Queue)
- Debe ser **idempotente** (puede ejecutarse múltiples veces)

```
S3 Event → Lambda (retry 1) → fail
                  ↓
           Lambda (retry 2) → fail
                  ↓
           Lambda (retry 3) → fail
                  ↓
                 DLQ (SNS/SQS)
```

---

## Arquitectura: S3 → SNS → Lambda vs S3 → SNS → SQS → Lambda

### Opción 1: S3 → SNS → Lambda
```
S3 → SNS → Lambda (inmediato, paralelo)
         → Lambda
         → Lambda
         → Lambda...
```
- Ejecución INMEDIATA
- Alta concurrencia
- Si falla → se pierde (usar DLQ)

### Opción 2: S3 → SNS → SQS → Lambda
```
S3 → SNS → SQS ──► Lambda (batch de 10)
              ──► Lambda (batch de 10)
```
- Más lento pero más controlado
- Batch processing
- Si falla → mensaje queda en SQS (retry automático)
- Más resiliente

---

## Puntos Clave Examen

1. **Lambda en public subnet** = NO tiene internet
2. **Lambda en private subnet + NAT** = tiene internet
3. **IP fija** = NAT Gateway con Elastic IP
4. **VPC Endpoint** = acceder a DynamoDB/S3 sin internet
5. **Async** = 3 retries, DLQ para fallos
6. **S3 → SNS → Lambda** = rápido pero puede perder data
7. **S3 → SNS → SQS → Lambda** = más lento pero resiliente

