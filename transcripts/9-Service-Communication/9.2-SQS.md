# 9.2 SQS (Simple Queue Service)

## Basics

- Serverless, managed queue
- Fully integrated con IAM
- **Extreme scale** (Standard) - no provisioning
- Propósito: **decouple** servicios, escalar independiente, trabajo async
- Max message size: **256 KB** (el transcript dice 1024KB pero es 256KB)

## Mensajes grandes (>256KB)

```
Producer → S3 (archivo) → SQS (solo la key) → Consumer → S3 (descarga)
```

## Consumers

- EC2 instances (con Auto Scaling Group)
- Lambda function (event source mapping)

## SQS como Write Buffer

```
Requests → SQS → App → DynamoDB
         (absorbe picos)
```
Evita throttling en DynamoDB

## Standard vs FIFO

| | Standard | FIFO |
|---|----------|------|
| Orden | Best effort | Garantizado |
| Throughput | Ilimitado | 300/s (3000 con batch) |
| Duplicados | Posibles | Deduplication |

## Dead Letter Queue (DLQ)

- Cola donde van mensajes que fallan N veces
- Configurar `MaximumReceives` threshold
- DLQ de FIFO = FIFO, DLQ de Standard = Standard
- Retention recomendado: **14 días**

## Redrive to Source

- Feature para re-enviar mensajes de DLQ → source queue
- Flujo: debug mensaje → fix código → redrive → reprocesar

## Idempotencia

- Mensajes pueden procesarse 2+ veces
- Consumer DEBE ser idempotente
- Ejemplo: usar UPSERT en DynamoDB (no INSERT)

## Lambda + SQS

- Event source mapping con long polling
- Batch size: 1-10 mensajes
- **Queue Visibility Timeout = 6x Lambda timeout**
- DLQ configurar en **SQS**, NO en Lambda
- Alternativa: Lambda Destinations

## Request-Response Pattern

```
Clients → SQS Request Queue → Worker → SQS Response Queue → Clients
```
- Decoupling completo
- Fault tolerance
- Load balancing horizontal

## Para el examen

| Ves en pregunta | Respuesta |
|-----------------|-----------|
| Decouple servicios | SQS |
| Mensaje > 256KB | S3 + SQS (solo key) |
| Orden garantizado | SQS FIFO |
| Alto throughput sin orden | SQS Standard |
| Mensajes que fallan repetidamente | Dead Letter Queue |
| Re-procesar mensajes de DLQ | Redrive to Source |
| Lambda + SQS visibility timeout | 6x Lambda timeout |
| DLQ con Lambda+SQS | Configurar en SQS (no Lambda) |
