# 8.3 RDS

## Basics (ya lo sabés)

**6 engines:** PostgreSQL, MySQL, MariaDB, IBM DB2, Oracle, Microsoft SQL Server

- Managed: backups, patching, monitoring automático
- Storage: EBS con auto-scaling
- Deploy: VPC private subnet + security groups
- Lambda + RDS: Lambda DEBE estar en VPC para conectar

## Backups vs Snapshots

| | Backups | Snapshots |
|---|---------|-----------|
| Tipo | Automático | Manual |
| Retención | Expiran (configurable) | Para siempre |
| PITR | Sí (point-in-time recovery) | No |
| Cross-region | No | Sí (copy) |

## Multi-AZ vs Read Replicas (IMPORTANTE)

```
MULTI-AZ (Failover/DR)
──────────────────────
Master (AZ-A) ←── SYNC ──→ Standby (AZ-B)
     │                          │
     └── DNS único ─────────────┘
         (failover automático)

- Standby NUNCA se usa (solo backup)
- Replicación SÍNCRONA
- Para: Alta disponibilidad


READ REPLICAS (Escalar lecturas)
────────────────────────────────
Master ←── ASYNC ──→ Replica 1
                 ──→ Replica 2
                 ──→ Replica 3

- Replicas SÍ se usan (reads)
- Replicación ASÍNCRONA (eventual consistency)
- Pueden ser cross-region
- Para: Escalar lecturas, reducir latencia
```

## Route 53 + Read Replicas

```
App ──→ Route 53 (Weighted Record Set)
              │
              ├── 25% → Replica 1
              ├── 25% → Replica 2
              ├── 25% → Replica 3
              └── 25% → Replica 4

+ Health Checks = excluye replicas con problemas
```

## Security

| Feature | Engines soportados |
|---------|-------------------|
| KMS encryption (EBS) | Todos |
| TDE (Transparent Data Encryption) | Oracle, SQL Server |
| SSL in-flight | Todos |
| IAM Authentication | MySQL, PostgreSQL, MariaDB |

**IAM Auth flow:**
```
EC2 (IAM Role) → API call → Auth Token (15 min) → RDS (SSL)
```

**Nota:** IAM autentica, pero autorización (permisos dentro de DB) sigue siendo en RDS.

**Encrypt unencrypted DB:** Snapshot → Copy encrypted → Restore

## Oracle específicos (CAE EN EXAMEN)

| Backup type | Restore a... |
|-------------|--------------|
| RDS Backups | RDS Oracle |
| Oracle RMAN | External Oracle (NO RDS) |

```
RDS Oracle ──→ RDS Backup ──→ RDS Oracle ✅
RDS Oracle ──→ RMAN ──→ S3 ──→ External Oracle ✅
RDS Oracle ──→ RMAN ──→ RDS Oracle ❌ NO FUNCIONA
```

**RAC (Real Application Clusters):** NO soportado en RDS. Solo en EC2.

## MySQL específico

**mysqldump:** Para migrar RDS MySQL → non-RDS (on-premises o EC2)

## RDS Proxy (Lambda)

```
PROBLEMA:
Lambda 1 ──┐
Lambda 2 ──┼──→ RDS = "TooManyConnections" exception
Lambda 3 ──┘
...
Lambda N ──┘

SOLUCIÓN:
Lambda 1 ──┐
Lambda 2 ──┼──→ RDS Proxy ──→ RDS (connection pooling)
Lambda 3 ──┘
...
Lambda N ──┘
```

- RDS Proxy: private subnet (no public)
- Soporta IAM auth + DB auth
- Auto-scaling

## Cross-Region Failover

```
us-east-1 (Master)          us-west-2 (Read Replica)
      │                            │
      └── async replication ───────┘

Route 53 Health Check
      │
      ▼
CloudWatch Alarm
      │
      ▼
EventBridge
      │
      ▼
Lambda: - Update DNS
        - Promote replica
```

## Para el examen

```
Failover automático mismo region   → Multi-AZ
Escalar lecturas                   → Read Replicas
Lambda + RDS connection issues     → RDS Proxy
Oracle RAC                         → Solo en EC2 (no RDS)
Oracle backup a external DB        → RMAN (no RDS Backups)
IAM auth para RDS                  → MySQL, PostgreSQL, MariaDB
Encrypt existing unencrypted DB    → Snapshot → Copy encrypted → Restore
```
