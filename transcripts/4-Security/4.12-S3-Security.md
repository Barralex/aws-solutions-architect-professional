# 4.12 S3 Security

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** 10 min

---

## Resumen

S3 tiene múltiples capas de seguridad: encryption at rest (SSE-S3, SSE-KMS, SSE-C), encryption in transit (HTTPS), bucket policies con conditions, pre-signed URLs, VPC endpoints, y Object Lock para compliance.

---

## 1. Encryption at Rest

| Tipo | Quién gestiona keys | Notas |
|------|---------------------|-------|
| **SSE-S3** | AWS | Default, simple |
| **SSE-KMS** | KMS | Auditable en CloudTrail, protege si bucket es público |
| **SSE-C** | Vos (client provides) | Requiere HTTPS obligatorio |
| **Client-side** | Vos | Encrypt/decrypt en tu lado |
| **Glacier** | AWS | AES-256 por default |

```
┌─────────────────────────────────────────────────────────────┐
│  SSE-KMS EXTRA SECURITY:                                    │
│                                                             │
│  • API calls aparecen en CloudTrail (auditoría)            │
│  • Si bucket es público pero objeto es SSE-KMS             │
│    → usuario anónimo NO puede leer (no tiene KMS access)   │
│  • Necesita permiso kms:GenerateDataKey para upload        │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Encryption in Transit

```
┌─────────────────────────────────────────────────────────────┐
│  HTTP  = sin encrypt (no usar)                              │
│  HTTPS = con SSL/TLS (usar siempre)                        │
│                                                             │
│  Forzar HTTPS en bucket policy:                            │
│  Condition: "aws:SecureTransport": "false" → Deny          │
│                                                             │
│  SSE-C REQUIERE HTTPS obligatorio                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Bucket Policy Conditions (IMPORTANTE)

```
┌─────────────────────────────────────────────────────────────┐
│  CONDITION KEY              USO                             │
│  ─────────────────────────────────────────────────────────  │
│  aws:SourceIp            → Public IP / Elastic IP          │
│  aws:VpcSourceIp         → Private IP (via VPC endpoint)   │
│  aws:SourceVpc           → Permitir todo un VPC            │
│  aws:SourceVpce          → Permitir VPC endpoint específico│
│  aws:SecureTransport     → Forzar HTTPS                    │
│  CloudFront OAI/OAC      → Solo acceso desde CloudFront    │
│  aws:MultiFactorAuth     → Requerir MFA                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. VPC Endpoint Gateway para S3

```
┌─────────────────────────────────────────────────────────────┐
│  OPCIÓN 1: Acceso público                                   │
│                                                             │
│  EC2 ──► Internet Gateway ──► S3 (público)                 │
│  Condition: aws:SourceIp (public IP)                       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  OPCIÓN 2: VPC Endpoint (privado, mejor)                    │
│                                                             │
│  EC2 ──► VPC Endpoint Gateway ──► S3 (privado)             │
│  Tráfico NO sale a internet                                │
│                                                             │
│  Conditions:                                                │
│  • aws:SourceVpce = VPC endpoint específico                │
│  • aws:SourceVpc = todo el VPC                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. Pre-signed URLs

```
┌─────────────────────────────────────────────────────────────┐
│  URL firmada con tus credenciales IAM                       │
│  Quien la tenga tiene TUS permisos (temporalmente)         │
│                                                             │
│  • Default: 1 hora (configurable con --expires-in)         │
│  • Para GET (download) o PUT (upload)                      │
│                                                             │
│  Casos de uso:                                              │
│  • Download de video premium para usuarios logueados       │
│  • Upload temporal a ubicación específica                  │
│  • Compartir archivos sin hacer bucket público             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Object Lock & Glacier Vault Lock

```
┌─────────────────────────────────────────────────────────────┐
│  WORM = Write Once, Read Many                               │
│                                                             │
│  S3 OBJECT LOCK:                                            │
│  • Bloquea eliminación de object version                   │
│  • Por tiempo específico                                   │
│                                                             │
│  GLACIER VAULT LOCK:                                        │
│  • Lockea la policy (no se puede cambiar)                  │
│  • Objetos NUNCA se pueden borrar                          │
│                                                             │
│  Para compliance y auditoría                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. S3 Events

```
┌─────────────────────────────────────────────────────────────┐
│  S3 Access Logs    → Logs a otro bucket (best effort)      │
│  S3 Event Notif    → SNS, SQS, Lambda (segundos)           │
│  EventBridge       → Requiere CloudTrail object-level      │
└─────────────────────────────────────────────────────────────┘
```

---

## Puntos Clave para el Examen

1. **SSE-KMS** = auditable, protege aunque bucket sea público
2. **aws:SecureTransport** = forzar HTTPS
3. **SourceIp** = public IP, **SourceVpc/SourceVpce** = VPC endpoint
4. **Pre-signed URL** = hereda permisos del creador
5. **Object Lock/Vault Lock** = WORM, compliance, no se puede borrar

