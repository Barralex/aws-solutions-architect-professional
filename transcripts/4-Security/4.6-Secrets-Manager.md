# 4.6 AWS Secrets Manager

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** 5 min

---

## Resumen

Secrets Manager almacena secretos (passwords, API keys) con **rotación automática** integrada. Tiene integración nativa con RDS, Redshift, DocumentDB. Encriptación KMS obligatoria.

---

## 1. Qué es Secrets Manager

```
┌─────────────────────────────────────────────────────────────┐
│  SECRETS MANAGER                                            │
│                                                             │
│  • Almacena passwords, API keys, secretos                  │
│  • Rotación AUTOMÁTICA cada X días                         │
│  • Encriptación KMS OBLIGATORIA                            │
│  • Resource-based policies para control de acceso          │
└─────────────────────────────────────────────────────────────┘
```

### Rotación automática

```
┌─────────────────────────────────────────────────────────────┐
│  ROTACIÓN CON LAMBDA                                        │
│                                                             │
│  Secrets Manager                                            │
│       │                                                     │
│       │ cada 30 días                                        │
│       ▼                                                     │
│  ┌──────────────┐     ┌──────────────┐                     │
│  │    Lambda    │────►│     RDS      │                     │
│  │  (rotation)  │     │  (cambia     │                     │
│  └──────────────┘     │   password)  │                     │
│       │               └──────────────┘                     │
│       │                                                     │
│       ▼                                                     │
│  Actualiza secreto en Secrets Manager                      │
│                                                             │
│  Para RDS/Redshift/DocumentDB: Lambda viene incluida       │
│  Para otros servicios: escribís tu propia Lambda           │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Integraciones Nativas

```
┌─────────────────────────────────────────────────────────────┐
│  SERVICIOS QUE LEEN SECRETS MANAGER AUTOMÁTICAMENTE        │
│                                                             │
│  • ECS / Fargate → secretos como env vars                  │
│  • EKS                                                      │
│  • CodeBuild                                                │
│  • CloudFormation                                           │
│  • EMR                                                      │
│  • Parameter Store (via /aws/reference/secretsmanager/)    │
└─────────────────────────────────────────────────────────────┘
```

### Ejemplo: ECS + RDS

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ┌──────────────┐                                          │
│  │  ECS Task    │                                          │
│  │              │                                          │
│  │ DB_PASS=xxx  │ ← inyectado al boot                      │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ usa env var                                       │
│         ▼                                                   │
│  ┌──────────────┐     ┌──────────────┐                     │
│  │   Secrets    │◄───►│     RDS      │ linked              │
│  │   Manager    │     │              │                     │
│  └──────────────┘     └──────────────┘                     │
│                                                             │
│  Si rota el secreto, RDS también cambia                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Cross-Account Sharing

```
┌─────────────────────────────────────────────────────────────┐
│  NO SE USA RAM - Se usan Resource Policies                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Security Account                  Dev Account              │
│  ─────────────────                 ───────────              │
│                                                             │
│  ┌──────────────┐                  ┌──────────────┐        │
│  │   Secret     │◄─────────────────│    User      │        │
│  │              │  GetSecretValue  │              │        │
│  └──────┬───────┘                  └──────────────┘        │
│         │                                                   │
│         │ encrypted by                                      │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │   KMS Key    │◄─────────────────  kms:Decrypt           │
│  │              │                                          │
│  └──────────────┘                                          │
│                                                             │
│  NECESITÁS 2 POLICIES:                                     │
│  1. Resource Policy en el secreto → Allow GetSecretValue   │
│  2. KMS Key Policy → Allow kms:Decrypt                     │
│     (con condición: kms:ViaService = secretsmanager)       │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. Secrets Manager vs Parameter Store

| Característica | Secrets Manager | Parameter Store |
|---------------|-----------------|-----------------|
| **Rotación automática** | ✅ Sí (Lambda built-in para RDS) | ❌ No (manual con EventBridge) |
| **Encriptación KMS** | Obligatoria | Opcional |
| **Precio** | ~$0.40/secreto/mes | Gratis (Standard) |
| **Uso típico** | DB passwords, API keys | Configs, feature flags |
| **CloudFormation** | ✅ | ✅ |

---

## 5. Rotación: Automática vs Manual

### Secrets Manager (automático)

```
┌─────────────────────────────────────────────────────────────┐
│  Secrets Manager ──► Lambda (built-in) ──► RDS             │
│                          │                                  │
│                          └──► Actualiza secreto            │
│                                                             │
│  TODO automático, solo configurás "rotar cada 30 días"     │
└─────────────────────────────────────────────────────────────┘
```

### Parameter Store (manual)

```
┌─────────────────────────────────────────────────────────────┐
│  EventBridge (cada 30 días)                                │
│       │                                                     │
│       ▼                                                     │
│  Lambda (TÚ LA ESCRIBÍS)                                   │
│       │                                                     │
│       ├──► Cambia password en RDS                          │
│       └──► Actualiza Parameter Store                       │
│                                                             │
│  Vos mantenés todo                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Puntos Clave para el Examen

1. **Secrets Manager** = rotación automática, KMS obligatorio
2. **RDS/Redshift/DocumentDB** = Lambda de rotación incluida
3. **Otros servicios** = Lambda custom para rotar
4. **Cross-account** = Resource Policy + KMS Policy (NO RAM)
5. **Condición KMS** = `kms:ViaService = secretsmanager`
6. **ECS/EKS** = secretos inyectados como env vars al boot
7. **Parameter Store** = más barato, sin rotación automática

