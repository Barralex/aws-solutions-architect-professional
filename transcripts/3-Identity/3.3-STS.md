# 3.3 STS - Security Token Service

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 3 - Identity & Federation
**Duración:** 12 min

---

## Resumen

STS permite asumir roles y obtener credenciales temporales (15 min - 12 horas).

---

## Flujo Básico de AssumeRole

```
Usuario/App → STS AssumeRole API → Verifica permisos →
              Devuelve credenciales temporales →
              Usuario accede al rol destino
```

---

## Casos de Uso

1. **Acceso a recursos** en tu propia cuenta usando un rol
2. **Cross-account access** - Acceso entre cuentas que vos controlás
3. **Third-party access** - Acceso a cuentas de terceros (consultores, partners)
4. **Service roles** - Servicios AWS que necesitan acceder a recursos
5. **Identity Federation** - Usuarios externos autenticados

---

## Revocar Sesiones Activas

Podés invalidar todas las credenciales temporales de un rol:
- Agregar condición de tiempo a la política
- Usar la política managed: `AWSRevokeOlderSessions`

---

## Cross-Account Access (Cuentas que controlás)

### Ejemplo: Dev → Prod S3

```
┌─────────────────┐         ┌─────────────────┐
│   CUENTA DEV    │         │   CUENTA PROD   │
│                 │         │                 │
│  Developers     │         │  UpdateApp Role │
│  Group          │ ──STS──▶│  (acceso a S3)  │
│                 │         │                 │
└─────────────────┘         └─────────────────┘

1. Admin Prod: Crea rol "UpdateApp" con acceso a S3
2. Admin Dev: Da permiso al grupo Developers para AssumeRole
3. Developers: Llaman STS, obtienen credenciales, acceden S3
```

### Beneficios:
- Permiso explícito requerido
- Se puede agregar MFA al rol
- Auditoría con CloudTrail
- Least privilege

---

## Third-Party Access (El Confused Deputy Problem)

### El Problema SIN External ID:

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  TU CUENTA   │    │  TERCERO     │    │  ATACANTE    │
│              │    │  (consultor) │    │              │
│  ExampleRole │◀───│              │◀───│  Le da ARN   │
│              │    │  Asume rol   │    │  de TU rol   │
└──────────────┘    └──────────────┘    └──────────────┘

❌ El tercero no sabe si el ARN es tuyo o del atacante
❌ Sin querer, accede a TU cuenta pensando que accede al atacante
```

### La Solución: External ID

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  TU CUENTA   │    │  TERCERO     │    │  ATACANTE    │
│              │    │              │    │              │
│  ExampleRole │◀───│  Conoce el   │    │  NO conoce   │
│  + ExternalID│    │  External ID │    │  External ID │
│  secreto123  │    │  secreto123  │    │  ❌ BLOQUEADO │
└──────────────┘    └──────────────┘    └──────────────┘

✅ External ID = secreto compartido entre vos y el tercero
✅ Atacante no puede usar el rol porque no conoce el secreto
```

### Reglas del External ID:
- Secreto entre vos y el tercero
- Lo elige el TERCERO
- Se pasa al definir trust policy Y al hacer AssumeRole

---

## Session Tags

Podés pasar tags al hacer AssumeRole:

```
STS AssumeRole + Tag: Department=HR
         │
         ▼
Credenciales con tag Department=HR
         │
         ▼
S3 Bucket Policy:
  Condition: PrincipalTag/Department = HR
         │
         ▼
✅ Acceso permitido solo si el tag coincide
```

Útil para: Control de acceso basado en atributos (ABAC)

---

## APIs Importantes de STS

| API | Uso |
|-----|-----|
| **AssumeRole** | Básico - dentro o entre cuentas |
| **AssumeRoleWithSAML** | Federación con SAML 2.0 |
| **AssumeRoleWithWebIdentity** | IdP como Google, Facebook (usar Cognito en su lugar) |
| **GetSessionToken** | Para MFA |
| **GetFederationToken** | Proxy de federación en red corporativa |

> **Nota:** AWS recomienda usar Cognito en vez de AssumeRoleWithWebIdentity

---

## Key Points para el Examen

1. **Credenciales temporales:** 15 min a 12 horas
2. **AssumeRole = pierdes permisos originales**
3. **External ID:** Protege contra Confused Deputy (PREGUNTA DE EXAMEN)
4. **Session Tags:** Para ABAC con PrincipalTag condition
5. **MFA en roles:** Capa extra de seguridad
6. **Cognito > AssumeRoleWithWebIdentity** para web/mobile

