# 9.5 SNS + SQS Fan Out Pattern

## Qué es

- Push once a SNS → múltiples SQS queues reciben
- Decoupling total, sin data loss
- SQS da: persistence, delayed processing, retries

## Por qué usar Fan Out

```
SIN Fan Out:
   App → SQS 1
   App → SQS 2  ← Si app crashea entre envíos, data loss
   App → SQS 3

CON Fan Out:
   App → SNS Topic → SQS 1
                   → SQS 2  ← SNS garantiza entrega a todos
                   → SQS 3
```

## Requisitos

- SQS Access Policy debe permitir SNS escribir
- Cross-region delivery soportado

## S3 Events + Fan Out

Limitación S3: 1 event rule por combinación (event type + prefix)

```
S3 (object:created, images/) → SNS Topic → SQS 1
                                         → SQS 2
                                         → Lambda
                                         → Email
```

## SNS → Kinesis Data Firehose → S3

```
App → SNS Topic → KDF → S3 / Redshift / etc.
```

Persistir mensajes de SNS a largo plazo.

## SNS FIFO + SQS FIFO

- Ordering por Message Group ID
- Deduplication (ID o content-based)
- Subscribers: SQS FIFO (o Standard)
- Throughput: mismo que SQS FIFO

## Message Filtering

- JSON policy en la subscription
- Sin filter = recibe TODO
- Con filter = solo mensajes que matchean

```
SNS Topic (orders)
    │
    ├── SQS Placed    ← filter: {"State": ["Placed"]}
    ├── SQS Canceled  ← filter: {"State": ["Canceled"]}
    ├── Email Canceled← filter: {"State": ["Canceled"]}
    └── SQS All       ← sin filter (recibe todo)
```

## Para el examen

| Ves en pregunta | Respuesta |
|-----------------|-----------|
| 1 mensaje → múltiples SQS | SNS + SQS Fan Out |
| S3 event a múltiples destinos | SNS Fan Out |
| Ordering + fan out | SNS FIFO + SQS FIFO |
| Solo ciertos mensajes a cierta cola | SNS Message Filtering |
| Persistir SNS a S3 | SNS → KDF → S3 |
