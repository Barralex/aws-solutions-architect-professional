# 3.1 IAM - Identity & Access Management

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 3 - Identity & Federation
**Duración:** 13 min

---

## Transcript

Empecemos con IAM.

En primer lugar, hay muchas cosas que ya deberías saber sobre IAM. Así que no voy a repasar lo básico. Intentaré recordarles de qué se trata.

### Usuarios, Grupos y Roles

- **Usuarios** tienen credenciales a largo plazo y por lo tanto son usuarios de AWS
- Puedes **agruparlos** en grupos
- También puedes definir **roles** que van a ser credenciales a corto plazo
- Usamos el servicio **STS** para asumir estos roles y obtener credenciales temporales

### Tipos de Roles

#### EC2 Instance Role
- Se utiliza el servicio de metadatos EC2 para obtener credenciales a corto plazo
- Solo se puede asignar un rol a la vez para la instancia
- Permite acceder a S3 buckets, DynamoDB tables, etc.

#### Service Roles
- Se asignan directamente a los servicios
- Ejemplo: API Gateway, CodeDeploy necesitan roles para acceder a Auto Scaling Groups, Lambda Functions, etc.

#### Cross-Account Roles
- Útiles para acceder a otra cuenta y realizar acciones
- **NUNCA** se comparten credenciales de usuario Cross Account
- Siempre se permite asumir roles

---

## Políticas IAM

Definen lo que un rol o usuario puede hacer.

### Tres tipos de políticas:

1. **AWS Managed** - Definidas por AWS, pueden cambiar con el tiempo
2. **Customer Managed** - Creadas por ti, asignables a múltiples usuarios/roles, versionables
3. **Inline Policies** - Asignadas a un usuario/rol específico, no compartibles

### Políticas basadas en recursos
- S3 Bucket Policy
- SQS Queue Policy
- Permiten patrones muy interesantes

---

## Estructura de una Política IAM

Documento JSON con:
- **Effect** (Allow/Deny)
- **Action**
- **Resource**
- **Conditions**
- **Policy Variables** (opcional)

```json
{
  "Effect": "Allow",
  "Action": ["ec2:AttachVolume", "ec2:DetachVolume"],
  "Resource": "*",
  "Condition": {
    "StringEquals": {
      "ec2:ResourceTag/Department": "Development"
    }
  }
}
```

### Regla importante:
> Si hay un **DENY explícito** en tu política IAM, tendrá precedencia sobre cualquier ALLOW

---

## Best Practice: Least Privilege

Asegurarse de que las políticas IAM solo puedan hacer lo que tienen que hacer y nada más.

### Herramientas:

1. **IAM Access Advisor**
   - Ver todos los permisos concedidos
   - Última vez que se accedió a cada permiso
   - Si no se usa en un año, considera eliminarlo

2. **IAM Access Analyzer**
   - Analiza recursos compartidos con entidades externas
   - Ejemplo: otras cuentas con acceso a tu S3 Bucket

---

## Políticas Comunes

### AdministratorAccess
```json
{
  "Effect": "Allow",
  "Action": "*",
  "Resource": "*"
}
```
- Por defecto todo está denegado
- Esta política permite todo

### PowerUserAccess
- Usa **NotAction** en lugar de Deny
- Permite todo EXCEPTO Organizations, IAM y Account
- Pero permite algunas acciones IAM específicas:
  - CreateServiceLinkedRole
  - DeleteServiceLinkedRole
  - ListRoles
  - DescribeOrganization
  - ListRegions

> **¿Por qué NotAction en lugar de Deny?**
> Si usas Deny explícito, las acciones que quieres permitir también serán denegadas (Deny siempre gana)

---

## Condiciones en Políticas IAM

### Operadores disponibles:

| Tipo | Operadores |
|------|-----------|
| **String** | StringEquals, StringLike |
| **Numeric** | NumericEquals, NumericNotEquals |
| **Date** | DateEquals, DateLessThan |
| **Boolean** | Bool |
| **IP Address** | IpAddress, NotIpAddress |
| **ARN** | ArnEquals, ArnLike |
| **Null** | Null |

### Ejemplos:

```json
// Solo SSL
"Condition": {
  "Bool": {"aws:SecureTransport": "true"}
}

// Solo con MFA
"Condition": {
  "Bool": {"aws:MultiFactorAuthPresent": "true"}
}

// Solo desde IP específica
"Condition": {
  "IpAddress": {"aws:SourceIp": "192.168.1.0/24"}
}
```

---

## Variables de Política

### Variable más común: `${aws:username}`

```json
{
  "Resource": "arn:aws:s3:::mybucket/${aws:username}/*"
}
```
Cada usuario tiene su propio directorio en el bucket.

### Variables AWS específicas:
- `aws:CurrentTime`
- `aws:TokenIssueTime`
- `aws:SecureTransport` (SSL)
- `aws:SourceIp`
- `aws:userid`
- `aws:SourceArn`

### Variables basadas en tags:
- `aws:ResourceTag/key-name`
- `aws:PrincipalTag/key-name`

---

## IAM Roles vs Resource-Based Policies

### Diferencia CLAVE:

| Aspecto | Asumir Rol | Resource-Based Policy |
|---------|------------|----------------------|
| Permisos originales | **RENUNCIAS** a tus permisos | **MANTIENES** tus permisos |
| Uso | Obtiene permisos del rol | El recurso permite acceso |

### Ejemplo: Usuario Cuenta A → S3 Bucket Cuenta B

**Opción 1: Asumir rol en Cuenta B**
- Usuario A asume rol en Cuenta B
- Pierde permisos de Cuenta A mientras usa el rol
- El rol tiene permisos para S3

**Opción 2: S3 Bucket Policy**
- Bucket policy permite al usuario de Cuenta A
- Usuario mantiene sus permisos de Cuenta A

### Caso de uso ideal para Resource-Based Policies:

Usuario necesita:
1. Escanear DynamoDB en Cuenta A (su cuenta)
2. Volcar datos a S3 en Cuenta B

**Solución:**
- Rol IAM en Cuenta A (para DynamoDB)
- S3 Bucket Policy en Cuenta B (permite al usuario)

### Servicios que soportan Resource-Based Policies:
- Amazon S3
- SNS Topics
- SQS Queues
- Lambda Functions
- ECR
- Backup
- EFS
- Glacier
- Cloud9
- Y muchos más...

---

## IAM Permission Boundaries

- Soportados para usuarios y roles (NO grupos)
- Establece los **permisos máximos** que una entidad IAM puede obtener

### Ejemplo:

**Permission Boundary:**
```json
{
  "Effect": "Allow",
  "Action": ["s3:*", "cloudwatch:*", "ec2:*"],
  "Resource": "*"
}
```

**IAM Policy:**
```json
{
  "Effect": "Allow",
  "Action": "iam:CreateUser",
  "Resource": "*"
}
```

**Resultado:** Sin permisos efectivos
- Aunque IAM CreateUser está permitido
- El boundary solo permite S3, CloudWatch, EC2
- La intersección es vacía

### Se combinan con SCPs de Organizations:

```
Permisos efectivos = SCP ∩ Permission Boundary ∩ Identity-based Policies
```

### Casos de uso:
1. Delegar responsabilidades a no-administradores dentro de límites
2. Permitir a desarrolladores auto-asignarse políticas sin escalada de privilegios
3. Restringir un usuario específico sin usar SCP de toda la cuenta

---

## Resumen

- IAM es fundamental para toda la seguridad de AWS
- Conocer la diferencia entre roles y resource-based policies es **clave para el examen**
- Permission Boundaries permiten control granular
- Siempre aplicar **least privilege**
