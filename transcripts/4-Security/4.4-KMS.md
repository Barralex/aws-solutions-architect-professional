# 4.4 AWS KMS - Key Management Service

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** ~10 min

---

## Resumen

KMS (Key Management Service) es el servicio de cifrado de AWS. Cada vez que escuches "cifrado" en AWS, piensa en KMS. Gestiona claves de cifrado, está integrado con IAM para autorización, y funciona con casi todos los servicios AWS (EBS, S3, RDS, Redshift, SSM, etc.).

**Importante:** Las claves KMS son REGIONALES. Solo pueden usarse en la región donde se crean (excepto Multi-Region Keys).

---

## 1. Tipos de Claves: Simétricas vs Asimétricas

### Claves Simétricas (AES-256)
```
┌─────────────────────────────────────────────────────────────┐
│  CLAVE SIMÉTRICA                                            │
│                                                             │
│  UNA sola clave para cifrar Y descifrar                     │
│                                                             │
│      Datos ──► [Clave X] ──► Cifrado                       │
│      Cifrado ──► [Clave X] ──► Datos                       │
│                                                             │
│  • Usada por TODOS los servicios AWS integrados            │
│  • Necesaria para Envelope Encryption                       │
│  • NUNCA ves la clave sin cifrar                           │
│  • Solo llamadas API a KMS                                  │
└─────────────────────────────────────────────────────────────┘
```

### Claves Asimétricas (RSA, ECC)
```
┌─────────────────────────────────────────────────────────────┐
│  CLAVE ASIMÉTRICA                                           │
│                                                             │
│  PAR de claves: Pública + Privada                          │
│                                                             │
│      Datos ──► [Clave Pública] ──► Cifrado                 │
│      Cifrado ──► [Clave Privada] ──► Datos                 │
│                                                             │
│  • Puedes DESCARGAR la clave pública                       │
│  • Clave privada: solo vía API KMS                         │
│  • Operaciones: Encrypt/Decrypt, Sign/Verify               │
│                                                             │
│  Caso de uso: Cifrar FUERA de AWS por usuarios que         │
│  NO pueden llamar a la API de KMS                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Tipos de Claves KMS

| Tipo | Quién la gestiona | Rotación | Puedes usarla | Puedes verla |
|------|-------------------|----------|---------------|--------------|
| **Customer Managed** | Tú | Opcional (1 año) | ✅ Sí | ✅ Sí |
| **AWS Managed** | AWS | Obligatoria (1 año) | ✅ Sí (solo servicios) | ✅ Sí |
| **AWS Owned** | AWS | Varía | ❌ No | ❌ No |

### Customer Managed Keys (Claves gestionadas por el cliente)
```
┌─────────────────────────────────────────────────────────────┐
│  CUSTOMER MANAGED KEY                                       │
│                                                             │
│  • TÚ la creas en KMS                                      │
│  • TÚ la gestionas (habilitar/deshabilitar)                │
│  • Puedes definir Key Policy (política de recursos)        │
│  • Rotación automática opcional (cada año)                 │
│  • Auditable en CloudTrail                                 │
│  • Usada para Envelope Encryption                          │
└─────────────────────────────────────────────────────────────┘
```

### AWS Managed Keys
```
┌─────────────────────────────────────────────────────────────┐
│  AWS MANAGED KEY                                            │
│                                                             │
│  Formato: aws/s3, aws/ebs, aws/rds, etc.                   │
│                                                             │
│  • Creada y rotada por AWS automáticamente                 │
│  • Solo usable por servicios AWS (no tus apps)             │
│  • Puedes ver la Key Policy                                │
│  • Auditable en CloudTrail                                 │
│  • Rotación OBLIGATORIA cada año                           │
└─────────────────────────────────────────────────────────────┘
```

### AWS Owned Keys
```
┌─────────────────────────────────────────────────────────────┐
│  AWS OWNED KEY                                              │
│                                                             │
│  • Usadas internamente por AWS                             │
│  • Pueden usarse en múltiples cuentas AWS                  │
│  • NO están en tu cuenta                                   │
│  • NO puedes ver, usar, rastrear ni auditar               │
│  • Solo sabes que existen                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Key Material Origin (Fuente del material de clave)

**No se puede cambiar después de crear la clave.**

| Origen | Descripción |
|--------|-------------|
| **AWS_KMS** | KMS genera y gestiona el material (default) |
| **External** | Tú importas tu propio material (BYOK) |
| **AWS_CLOUDHSM** | Material almacenado en tu cluster CloudHSM |

---

## 4. Custom Key Store con CloudHSM

```
┌─────────────────────────────────────────────────────────────┐
│  CUSTOM KEY STORE + CLOUDHSM                                │
│                                                             │
│  ┌─────────────────────────────────────────────┐           │
│  │             CloudHSM Cluster                 │           │
│  │  ┌─────────┐              ┌─────────┐       │           │
│  │  │  HSM    │              │  HSM    │       │           │
│  │  │  AZ-1   │              │  AZ-2   │       │           │
│  │  └────┬────┘              └────┬────┘       │           │
│  │       │    Material de        │             │           │
│  │       │    claves aquí        │             │           │
│  │       └──────────┬────────────┘             │           │
│  └──────────────────┼──────────────────────────┘           │
│                     │                                       │
│                     ▼                                       │
│              ┌─────────────┐                               │
│              │     KMS     │ ← Usuarios usan API KMS       │
│              └─────────────┘                               │
│                                                             │
│  Requisito: Mínimo 2 HSMs para alta disponibilidad         │
│                                                             │
│  Caso de uso:                                              │
│  • Control directo sobre HSMs                              │
│  • Requisitos de seguridad estrictos                       │
│  • Almacenar claves en entorno HSM dedicado                │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. Claves Externas (BYOK - Bring Your Own Key)

```
┌─────────────────────────────────────────────────────────────┐
│  IMPORTAR MATERIAL DE CLAVE EXTERNO                         │
│                                                             │
│  Restricciones:                                             │
│  • Solo claves SIMÉTRICAS de 256 bits                      │
│  • NO compatible con Custom Key Store                       │
│  • Rotación automática NO soportada (manual)               │
│  • TÚ eres responsable de seguridad y durabilidad          │
│                                                             │
│  Proceso:                                                   │
│                                                             │
│  1. Crear clave KMS (simétrica, origen: externo)           │
│     └── Se crea el "sobre" pero SIN material              │
│                                                             │
│  2. Descargar clave pública + token de importación         │
│                                                             │
│  3. Cifrar tu material con la clave pública                │
│     ┌──────────────┐    ┌─────────────┐                    │
│     │ Tu material  │ ──►│Clave pública│──► Material cifrado│
│     │   256-bit    │    └─────────────┘                    │
│     └──────────────┘                                        │
│                                                             │
│  4. Enviar material cifrado + token a KMS                  │
│                                                             │
│  5. KMS descifra y almacena el material                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Multi-Region Keys

```
┌─────────────────────────────────────────────────────────────┐
│  MULTI-REGION KEYS                                          │
│                                                             │
│  ┌───────────────┐     ┌───────────────┐                   │
│  │   US-EAST-1   │     │   EU-WEST-1   │                   │
│  │               │     │               │                   │
│  │  Key: abc123  │────►│  Key: abc123  │ ← Mismo ID!       │
│  │   (PRIMARY)   │     │   (REPLICA)   │                   │
│  └───────────────┘     └───────────────┘                   │
│          │                                                  │
│          ▼                                                  │
│  ┌───────────────┐                                         │
│  │  AP-SOUTH-1   │                                         │
│  │               │                                         │
│  │  Key: abc123  │                                         │
│  │   (REPLICA)   │                                         │
│  └───────────────┘                                         │
│                                                             │
│  Características:                                           │
│  • Mismo Key ID en todas las regiones                      │
│  • Mismo material de clave                                 │
│  • Misma rotación automática                               │
│  • NO son claves globales (una primaria + réplicas)        │
│  • Cada clave se gestiona independientemente               │
│  • Puedes promover réplica a primaria                      │
│                                                             │
│  Beneficio clave:                                          │
│  Cifrar en una región, descifrar en otra                   │
│  SIN re-cifrar ni llamadas cross-region                    │
└─────────────────────────────────────────────────────────────┘
```

### Casos de uso Multi-Region Keys:
- Disaster Recovery
- Global Data Management (ej: DynamoDB Global Tables)
- Aplicaciones Active-Active multi-región
- Distribución de firmas

---

## Puntos Clave para el Examen

1. **Cifrado en AWS = KMS**
2. **Claves son REGIONALES** (excepto Multi-Region)
3. **Simétrica** = todos los servicios AWS, nunca ves la clave
4. **Asimétrica** = cifrar fuera de AWS sin API KMS
5. **Customer Managed** = tú controlas, rotación opcional
6. **AWS Managed** = aws/servicio, rotación obligatoria
7. **AWS Owned** = invisibles, no auditables
8. **CloudHSM** = control total, mínimo 2 HSMs
9. **BYOK** = solo simétrica 256-bit, rotación manual
10. **Multi-Region** = mismo ID, cifrar/descifrar cross-region

