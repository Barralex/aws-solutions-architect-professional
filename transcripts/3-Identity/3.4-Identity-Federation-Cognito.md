# 3.4 Identity Federation & Cognito

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 3 - Identity & Federation
**Duración:** 9 min

---

## Resumen

Identity Federation permite que usuarios externos a AWS (ej: empleados corporativos) accedan a recursos AWS sin crear usuarios IAM individuales.

---

## Concepto General

```
Usuario externo → Proveedor de Identidad (IdP) → Token/Aserción →
                  STS → Credenciales temporales → Acceso a AWS
```

### Casos de Uso:
- Empresa con sistema de identidad propio (Active Directory)
- Apps web/mobile que necesitan acceso a AWS

---

## Tipos de Identity Federation

| Tipo | Uso | API STS |
|------|-----|---------|
| **SAML 2.0** | Corporativo (ADFS, Active Directory) | AssumeRoleWithSAML |
| **Custom Identity Broker** | IdP no compatible con SAML 2.0 | AssumeRole o GetFederationToken |
| **Web Identity (sin Cognito)** | Apps web/mobile (DEPRECATED) | AssumeRoleWithWebIdentity |
| **Web Identity (con Cognito)** | Apps web/mobile (RECOMENDADO) | Cognito maneja STS |
| **IAM Identity Center** | Nuevo estándar (SSO) | Manejado por AWS |

---

## SAML 2.0 Federation

### Qué es SAML:
- **Security Assertion Markup Language**
- Estándar abierto para autenticación
- Usado por ADFS (Active Directory Federation Services)

### Flujo para API Access:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CORPORACIÓN   │    │      STS        │    │      AWS        │
│                 │    │                 │    │                 │
│  1. Usuario     │    │                 │    │                 │
│     → IdP       │    │                 │    │                 │
│                 │    │                 │    │                 │
│  2. IdP verifica│    │                 │    │                 │
│     con LDAP    │    │                 │    │                 │
│                 │    │                 │    │                 │
│  3. Devuelve    │    │                 │    │                 │
│     SAML        │────│→ 4. AssumeRole  │    │                 │
│     Assertion   │    │    WithSAML     │    │                 │
│                 │    │                 │    │                 │
│                 │    │  5. Credenciales│────│→ 6. Acceso API  │
│                 │    │     temporales  │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Flujo para Consola AWS:

```
Usuario → IdP → SAML Assertion → POST a signin.aws.amazon.com/saml
        → STS devuelve Sign-in URL → Redirect a Console
```

---

## Custom Identity Broker

### Cuándo usarlo:
- Tu IdP **NO** es compatible con SAML 2.0

### Flujo:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    USUARIO      │    │ IDENTITY BROKER │    │      STS        │
│                 │    │    (custom)     │    │                 │
│  1. Login       │────│→               │    │                 │
│                 │    │  2. Verifica    │    │                 │
│                 │    │     identidad   │    │                 │
│                 │    │                 │    │                 │
│                 │    │  3. Solicita    │────│→ AssumeRole o   │
│                 │    │     creds       │    │  GetFederation  │
│                 │    │                 │    │  Token          │
│                 │    │  4. Creds       │←───│                 │
│  5. Recibe      │←───│     temp        │    │                 │
│     creds       │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**Importante:** El broker determina qué rol IAM asignar al usuario.

---

## Web Identity Federation

### Sin Cognito (DEPRECATED):

```
Cliente → Login con Google/Facebook/Amazon → Token Web Identity
       → STS AssumeRoleWithWebIdentity → Credenciales temporales
       → Acceso directo a AWS
```

**AWS NO recomienda este método.**

### Con Cognito (RECOMENDADO):

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    CLIENTE      │    │    COGNITO      │    │      STS        │
│                 │    │                 │    │                 │
│  1. Login con   │    │                 │    │                 │
│     Google/FB   │    │                 │    │                 │
│                 │    │                 │    │                 │
│  2. Token IdP   │────│→ 3. Intercambia │    │                 │
│                 │    │    por Token    │    │                 │
│                 │    │    Cognito      │    │                 │
│                 │    │                 │    │                 │
│  4. Token       │←───│                 │────│→ 5. Creds temp  │
│     Cognito     │    │                 │    │                 │
│                 │    │                 │    │                 │
│  6. Acceso AWS  │────│─────────────────│────│→               │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Beneficios de Cognito:
- Soporta **usuarios anónimos**
- Soporta **MFA**
- **Sincronización de datos** entre dispositivos
- Funciona como "Token Vending Machine"

---

## Variables de Política IAM para Web Identity

Podés usar variables especiales en condiciones IAM:

```json
{
  "Condition": {
    "StringEquals": {
      "cognito-identity.amazonaws.com:sub": "${cognito-identity.amazonaws.com:sub}"
    }
  },
  "Resource": "arn:aws:s3:::mybucket/${cognito-identity.amazonaws.com:sub}/*"
}
```

### Variables disponibles:
- `cognito-identity.amazonaws.com:sub`
- `www.amazon.com:user_id`
- `graph.facebook.com:id`
- `accounts.google.com:sub`

**Uso:** Restringir acceso a S3 por usuario federado (cada usuario su carpeta).

---

## Comparación de Métodos

| Método | Entorno | Recomendado |
|--------|---------|-------------|
| SAML 2.0 | Corporativo (ADFS) | ✅ Sí (pero IAM Identity Center es más nuevo) |
| Custom Broker | Corporativo sin SAML | Solo si no hay alternativa |
| Web Identity sin Cognito | Apps web/mobile | ❌ DEPRECATED |
| Web Identity con Cognito | Apps web/mobile | ✅ RECOMENDADO |
| IAM Identity Center | Cualquiera | ✅ Más nuevo y simple |

---

## Key Points para el Examen

1. **SAML 2.0** = Corporativo, Active Directory, usa `AssumeRoleWithSAML`
2. **Custom Identity Broker** = Solo si IdP no soporta SAML 2.0
3. **Cognito** = Apps web/mobile, SIEMPRE preferir sobre Web Identity directo
4. **IAM Identity Center** = Nueva generación de SSO (verlo en lección separada)
5. **Variables de política** = Para restringir acceso por usuario federado
6. **Token Vending Machine** = Cognito intercambia tokens por credenciales

