# 7.3 Lambda@Edge & CloudFront Functions

## Concepto
Ejecutar código en el edge, cerca del usuario. Sin servers.

## Dónde corren

```
Usuario → Edge Location → Regional Edge Cache → Origin
              │                    │
              │                    └── Lambda@Edge
              │
              └── CloudFront Functions
```

## Los 4 triggers

```
         VIEWER REQUEST ←── CloudFront Functions + Lambda@Edge
                │
         ORIGIN REQUEST ←── Solo Lambda@Edge
                │
           [ORIGIN]
                │
        ORIGIN RESPONSE ←── Solo Lambda@Edge
                │
        VIEWER RESPONSE ←── CloudFront Functions + Lambda@Edge
```

## Comparación

| | CloudFront Functions | Lambda@Edge |
|---|---------------------|-------------|
| Runtime | JavaScript puro | Node.js, Python |
| Dónde corre | Edge Locations | Regional Edge Cache |
| Triggers | Viewer only | Todos (4) |
| Tiempo máx | 1ms | 5s (viewer) / 30s (origin) |
| Memoria | 2 MB | 128 MB - 10 GB |
| Tamaño paquete | 10 KB | 1-50 MB |
| Network access | ❌ | ✅ |
| File system | ❌ | ✅ |
| Request body | ❌ | ✅ |
| Costo | 1/6 de Lambda@Edge | Más caro |
| Free tier | ✅ | ❌ |

## Cuándo usar cada uno

### CloudFront Functions (rápido, simple, barato)
- Normalizar cache keys (headers, cookies, query strings)
- Manipular headers (add/remove/modify)
- URL rewrites/redirects
- Validar JWT en el edge (auth simple)

### Lambda@Edge (potente, lento, caro)
- Llamar APIs externas
- Usar AWS SDK (DynamoDB, S3, etc.)
- Lógica compleja (>1ms)
- Acceder al body del request
- Depender de librerías externas

## Casos de uso reales

### 1. Auth con JWT (CloudFront Functions)
```
Request → Edge → Verificar JWT en header
                      │
            ┌─────────┴─────────┐
            ▼                   ▼
         Válido              Inválido
            │                   │
            ▼                   ▼
        Origin              403 Error
                         (sin ir a origin)
```

### 2. Imagen por dispositivo (Lambda@Edge)
```
User-Agent: iPhone
     │
     ▼
Lambda@Edge lee header
     │
     ▼
Cambia request: cat.jpg → cat-mobile.jpg
     │
     ▼
S3 devuelve imagen pequeña
```

### 3. API Global Serverless (Lambda@Edge)
```
Cliente → CloudFront → Lambda@Edge → DynamoDB Global Tables

100% serverless, baja latencia global
```

## Para el examen

```
Lógica simple, <1ms, solo headers    → CloudFront Functions
Llamar API externa, SDK, body access → Lambda@Edge
Viewer request/response              → Ambos
Origin request/response              → Solo Lambda@Edge
Más barato                           → CloudFront Functions
```
