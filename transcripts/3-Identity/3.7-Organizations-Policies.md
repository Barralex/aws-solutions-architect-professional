# 3.7 AWS Organizations Policies (SCPs)

## Resumen
Las Service Control Policies (SCPs) son barreras que limitan qué pueden hacer las cuentas miembro en una organización. NO otorgan permisos, solo los restringen. También existen otros tipos de políticas: Tag Policies, AI Opt-out Policies, y Backup Policies.

---

## Conceptos Clave

### 1. Service Control Policies (SCPs)

**¿Qué son?**
- Allowlist o Blocklist para acciones IAM específicas
- Se aplican a nivel de OU o Account
- NO otorgan permisos, solo LIMITAN

**Reglas importantes:**
- **NO aplican a la Management Account** (protección contra bloqueo)
- Aplican a TODOS los usuarios y roles, incluido root
- **NO afectan a Service-Linked Roles** (roles que usan otros servicios AWS)
- Requieren **Allow explícito en cada nivel** del path (Root → OU → Account)

### 2. Herencia de SCPs

```
Root OU (FullAWSAccess)
    │
    ├── Management Account
    │   └── SCP Deny Athena → NO APLICA (es management)
    │
    ├── Sandbox OU (FullAWSAccess + Deny S3)
    │   ├── Account A (FullAWSAccess + Deny EC2)
    │   │   └── Resultado: Todo EXCEPTO S3 y EC2
    │   ├── Account B (sin SCP propio)
    │   │   └── Resultado: Todo EXCEPTO S3
    │   └── Account C (sin SCP propio)
    │       └── Resultado: Todo EXCEPTO S3
    │
    └── Workloads OU (FullAWSAccess)
        ├── Test OU (Allow EC2 only)
        │   └── Account D → SOLO puede usar EC2
        └── Prod OU (FullAWSAccess)
            └── Account E, F → Pueden hacer todo
```

**Clave:** Necesitás FullAWSAccess en cada nivel + los Deny específicos se heredan hacia abajo.

### 3. Ejemplos de SCPs

**Blocklist (denegar servicio específico):**
```json
{
  "Effect": "Allow",
  "Action": "*",
  "Resource": "*"
},
{
  "Effect": "Deny",
  "Action": "dynamodb:*",
  "Resource": "*"
}
```

**Allowlist (solo permitir servicios específicos):**
```json
{
  "Effect": "Allow",
  "Action": ["ec2:*", "cloudwatch:*"],
  "Resource": "*"
}
```

### 4. Restricciones con Condiciones

**Restringir por Región (aws:RequestedRegion):**
```json
{
  "Effect": "Deny",
  "Action": ["ec2:*", "rds:*"],
  "Resource": "*",
  "Condition": {
    "StringEquals": {
      "aws:RequestedRegion": ["eu-central-1", "eu-west-1"]
    }
  }
}
```

**Requerir Tags específicos (aws:TagKeys):**
```json
{
  "Condition": {
    "ForAllValues:StringEquals": {
      "aws:TagKeys": ["Env", "CostCenter"]
    }
  }
}
```
- `ForAllValues` = AMBAS tags requeridas
- `ForAnyValue` = al menos UNA tag requerida

### 5. IAM Policy Evaluation Logic

Orden de evaluación:
1. Explicit Deny → DENY
2. Organizations SCP → ¿Allow? Si no → DENY
3. Resource-based Policy → ¿Allow?
4. Identity-based Policy → ¿Allow?
5. IAM Permission Boundaries → ¿Allow?
6. Session Policies → ¿Allow?

**Resultado:** ALLOW solo si TODAS permiten

### 6. Otros tipos de Policies en Organizations

| Tipo | Propósito |
|------|-----------|
| **Tag Policies** | Estandarizar tags en toda la org, validar valores permitidos |
| **AI Services Opt-out** | Evitar que AWS use tus datos para mejorar servicios de IA |
| **Backup Policies** | Definir planes de backup centralizados (inmutables en member accounts) |

---

## Para el Examen

1. **SCP NO aplica a Management Account** - nunca, pase lo que pase
2. **SCP NO afecta Service-Linked Roles**
3. **Necesitás FullAWSAccess explícito** en cada nivel para que funcione
4. **Deny SIEMPRE gana** - se hereda hacia abajo
5. **aws:RequestedRegion** para bloquear regiones
6. **aws:TagKeys** con ForAllValues/ForAnyValue para requerir tags
7. **Backup Policies son inmutables** en cuentas miembro

---

## Diagrama: Evaluación de Permisos

```
┌─────────────────┐
│  Explicit Deny? │──Yes──► DENY
└────────┬────────┘
         │No
         ▼
┌─────────────────┐
│   SCP Allow?    │──No───► DENY (implicit)
└────────┬────────┘
         │Yes
         ▼
┌─────────────────┐
│ Resource Policy │──Yes──► ALLOW
│    Allow?       │
└────────┬────────┘
         │No
         ▼
┌─────────────────┐
│ Identity Policy │──No───► DENY
│    Allow?       │
└────────┬────────┘
         │Yes
         ▼
┌─────────────────┐
│  Permission     │──No───► DENY
│  Boundary OK?   │
└────────┬────────┘
         │Yes
         ▼
       ALLOW
```

---

*Siguiente: 3.8 AWS IAM Identity Center*
