# 4.17 AWS WAF - Web Application Firewall

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** ~7 min

---

## Resumen

WAF protege apps web de exploits en Layer 7 (HTTP). Se despliega en ALB, API Gateway, CloudFront o AppSync. Usa Web ACLs con reglas para filtrar IPs, headers, body, SQL injection, XSS, geo-blocking y rate limiting. Tiene 190+ managed rules listas para usar.

---

## Dónde se despliega WAF

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  ┌─────────────┐                                       │
│  │     ALB     │ ← WAF (reglas localizadas)            │
│  └─────────────┘                                       │
│                                                         │
│  ┌─────────────┐                                       │
│  │ API Gateway │ ← WAF (regional o edge)               │
│  └─────────────┘                                       │
│                                                         │
│  ┌─────────────┐                                       │
│  │ CloudFront  │ ← WAF (global, todos los edge)        │
│  └─────────────┘   Útil para CLB, EC2, S3 websites     │
│                                                         │
│  ┌─────────────┐                                       │
│  │  AppSync    │ ← WAF (protege GraphQL APIs)          │
│  └─────────────┘                                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**IMPORTANTE:** WAF NO es para DDoS → para eso está Shield

---

## Web ACL - Tipos de reglas

| Tipo de Regla | Qué hace |
|---------------|----------|
| **IP filtering** | Bloquea/permite IPs específicas |
| **HTTP headers/body** | Filtra por contenido del request |
| **URL strings** | Filtra por patrones en URL |
| **SQL injection** | Bloquea intentos de SQL injection |
| **XSS (Cross-site scripting)** | Bloquea scripts maliciosos |
| **Size constraints** | Rechaza requests > X MB |
| **Geo-match** | Bloquea/permite por país |
| **Rate-based** | Límite de requests por segundo |

---

## Rule Actions

| Acción | Qué hace |
|--------|----------|
| **Allow** | Deja pasar el tráfico |
| **Block** | Rechaza el tráfico |
| **Count** | Solo cuenta (para detectar false positives) |
| **CAPTCHA** | Verifica que no sea bot |

**Count** es útil para probar reglas antes de activar Block

---

## Managed Rules (190+)

```
┌─────────────────────────────────────────────────────────┐
│  MANAGED RULES - 4 categorías                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. BASELINE RULE GROUPS                               │
│     • Common Rule Set                                  │
│     • Admin Protection                                 │
│     • Protección general                               │
│                                                         │
│  2. USE-CASE SPECIFIC                                  │
│     • SQL Rule Set                                     │
│     • PHP Rule Set                                     │
│     • WordPress Rule Set                               │
│     • Windows Rule Set                                 │
│                                                         │
│  3. IP REPUTATION                                      │
│     • Amazon IP Reputation List ⭐ (cae en examen)     │
│     • Anonymous IP List                                │
│     • Bloquea IPs conocidas como maliciosas            │
│                                                         │
│  4. BOT CONTROL                                        │
│     • Bot Control Rule Set                             │
│     • Bloquea/gestiona requests de bots                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## WAF Logging

```
WAF Logs ─┬─► CloudWatch Logs (max 5 MB/s)
          │
          ├─► S3 Bucket (cada 5 minutos)
          │
          └─► Kinesis Data Firehose (sin límite WAF)
                    │
                    └─► S3, Redshift, OpenSearch...
```

**Para alto tráfico** → usar Kinesis Data Firehose

---

## Arquitectura: Proteger ALB con CloudFront + WAF

**Problema:** Quiero que SOLO CloudFront acceda al ALB (no acceso directo)

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  Usuario legítimo                Usuario malicioso      │
│        │                               │                │
│        ▼                               │                │
│  ┌───────────┐                         │                │
│  │ CloudFront│                         │                │
│  │   + WAF   │                         │                │
│  └─────┬─────┘                         │                │
│        │                               │                │
│        │ Header secreto:               │                │
│        │ X-Origin-Verify: abc123       │                │
│        ▼                               ▼                │
│  ┌─────────────────────────────────────────┐           │
│  │              ALB + WAF                   │           │
│  │  Regla: Solo permitir si tiene header   │           │
│  │         X-Origin-Verify: abc123         │           │
│  └─────────────────────────────────────────┘           │
│        │                               │                │
│        ▼                               ✗ BLOCKED        │
│     EC2/App                                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**Rotación del secreto:**
- Secrets Manager guarda el header secreto
- Lambda rota automáticamente
- Actualiza CloudFront y WAF

---

## Puntos Clave para el Examen

1. **WAF = Layer 7** (HTTP), Shield = Layer 3/4 (DDoS)
2. **Se despliega en:** ALB, API Gateway, CloudFront, AppSync
3. **Managed Rules:** 190+, incluye Amazon IP Reputation List
4. **Count action:** para probar reglas sin bloquear
5. **Alto tráfico logging:** usar Kinesis Data Firehose
6. **Proteger ALB:** header secreto en CloudFront + WAF en ALB

