# 4.3 CloudTrail - SA Pro

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** 7 min

---

## Transcript

Vamos a hablar de CloudTrail y algunas arquitecturas de soluciones que pueden ser interesantes.

### CloudTrail a S3

Puedes configurar un volcado de los archivos de CloudTrail en S3 cada cinco minutos.

**Encriptación:**
- Por defecto: SSE-S3
- Opcional: SSE-KMS (configuración manual)

**Mejoras de S3 disponibles:**
- Versionamiento para evitar borrados accidentales
- MFA Delete para protección de eliminación
- Lifecycle policies para mover a S3 IA o Glacier
- S3 Object Lock para asegurar que los objetos nunca se borren ni modifiquen
- Validación de integridad de archivos de registro (verifica que no han sido modificados)

### Notificaciones

Cuando se entrega un archivo en S3, puedes:
1. Usar S3 Events para notificar a SQS, SNS o Lambda
2. Hacer que CloudTrail envíe notificaciones directamente a SNS

```
                    ┌─────────────────────────────────────────┐
                    │                                         │
CloudTrail ──────►  S3  ──── S3 Events ───►  SQS / SNS / Lambda
    │               │
    │               └─────────────────────────────────────────┘
    │
    └──────────────► SNS ───────────►  SQS / Lambda
```

---

## CloudTrail Multi-Account y Multi-Region

Para centralizar logs de múltiples cuentas en una cuenta de seguridad:

```
┌─────────────────┐      ┌─────────────────┐
│   Account A     │      │   Account B     │
│   CloudTrail    │      │   CloudTrail    │
└────────┬────────┘      └────────┬────────┘
         │                        │
         └──────────┬─────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  Security Account   │
         │                     │
         │   S3 Bucket         │
         │   (con S3 Bucket    │
         │    Policy)          │
         └─────────────────────┘
```

**Importante:**
- La S3 Bucket Policy debe permitir que CloudTrail entregue archivos
- Para que Account A acceda a los logs:
  - Opción 1: Cross-Account Role (asumir rol en Security Account)
  - Opción 2: Editar Bucket Policy para permitir lecturas desde Account A

---

## Alertas con CloudWatch Logs

Para crear alertas cuando se realicen determinadas llamadas a la API:

```
CloudTrail ──► CloudWatch Logs ──► Metric Filter ──► CloudWatch Alarm ──► SNS ──► Lambda/SQS
```

**Metric Filters pueden detectar:**
- Una API específica (ej: TerminateInstances)
- Alto nivel de ocurrencias de una API
- Contar llamadas por usuario
- Alto nivel de llamadas denegadas (posible intento de violación de seguridad)

---

## Organization Trail

Si tienes AWS Organizations:

```
┌───────────────────────────────────────────────────────────┐
│                   Management Account                       │
│                                                            │
│   Organization Trail  ────────►  S3 Bucket                │
│         │                           │                      │
│         │                           └── /account-id-1/     │
│         ▼                              /account-id-2/      │
│   Monitorea TODAS                      /account-id-3/      │
│   las cuentas miembro                                      │
└───────────────────────────────────────────────────────────┘
         │
         ├──► Production OU (todas las cuentas monitoreadas)
         │
         └──► Development OU (todas las cuentas monitoreadas)
```

**Importante:** El trail se crea en la Management Account, NO en las cuentas miembro.

---

## Formas de Reaccionar a Eventos en CloudTrail

| Método | Velocidad | Caso de uso |
|--------|-----------|-------------|
| **EventBridge** | Más rápido | Reaccionar inmediatamente a cualquier API call |
| **CloudWatch Logs** | Medio | Contar ocurrencias, detectar anomalías, crear métricas |
| **S3** | Cada 5 min | Almacenamiento largo plazo, análisis a escala con Athena |

**Nota:** CloudTrail puede tardar hasta 15 minutos en entregar eventos.

---

## Puntos Clave para el Examen

1. **S3 + CloudTrail:** Lifecycle policies, Object Lock, validación de integridad
2. **Multi-Account:** S3 Bucket Policy es necesaria para cross-account delivery
3. **Organization Trail:** Se crea en Management Account
4. **Alertas:** CloudWatch Logs + Metric Filters + CloudWatch Alarms
5. **Reacción rápida:** EventBridge es la opción más rápida
6. **Análisis largo plazo:** S3 + Athena
