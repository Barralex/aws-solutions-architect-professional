# 5.16 API Gateway

## Qué es y para qué sirve
- Expone REST APIs a clientes
- Proxy a Lambda, HTTP backends, AWS Services
- Features: versioning, auth, throttling, caching, CORS, OpenAPI spec

## LÍMITES CRÍTICOS (EXAMEN!)
| Límite | Valor | Consecuencia |
|--------|-------|--------------|
| Timeout | **29 segundos** | Lambda puede durar 15 min, pero API GW corta a los 29s → 504 |
| Payload | **10 MB** | No sirve para upload de archivos grandes |

## Deployment Stages
- dev, test, prod (o los que quieras)
- Rollback posible (historial de deployments)
- Cada stage puede apuntar a diferentes Lambda aliases

## Tipos de Integración
1. **HTTP** - Backend HTTP on-premise o ALB
2. **Lambda** - El clásico serverless
3. **AWS Service** - Step Functions, SQS, S3 directo

## Patrón S3 Upload (IMPORTANTE EXAMEN)

**Malo:** API GW → S3 directo (límite 10MB)

**Bueno:** API GW → Lambda → genera Pre-signed URL → Cliente sube directo a S3 (sin límite)

## Endpoint Types
| Tipo | Descripción | Uso |
|------|-------------|-----|
| Edge-Optimized | Via CloudFront edges (default) | Clientes globales |
| Regional | Solo en la región | Clientes en misma región |
| Private | Solo en VPC via ENI | APIs internas |

## Caching
- TTL default: 300s (5 min), range: 0 a 3600s
- Por stage, override por método
- Cliente puede invalidar: `Cache-Control: max-age=0`
- Capacidad: 0.5 GB a 237 GB

## Error Codes
| Código | Significado |
|--------|-------------|
| 400 | Bad Request |
| 403 | Access Denied / WAF filtered |
| 429 | Throttle / Quota exceeded |
| 502 | Bad Gateway (Lambda retornó mal formato) |
| 503 | Service Unavailable (backend no responde) |
| 504 | Integration Failure (timeout 29s!) |

## Security
- **Resource Policy** - Quién puede acceder (accounts, IPs, VPCs)
- **IAM Execution Roles** - Permisos del API GW para invocar Lambda/services
- **CORS** - Qué dominios pueden llamar

## Authentication (3 formas)
1. **IAM** - Sig V4 headers, para acceso interno AWS
2. **Lambda Authorizer** - Custom auth (OAuth, SAML, 3rd party)
3. **Cognito User Pool** - Cliente autentica con Cognito, pasa token

## Logging & Monitoring
- CloudWatch Logs por stage
- CloudWatch Metrics (latency, cache hit/miss)
- X-Ray para tracing completo
