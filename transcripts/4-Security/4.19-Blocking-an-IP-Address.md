# 4.19 Blocking an IP Address

**Curso:** AWS Solutions Architect Professional (SAP-C02)
**Sección:** 4 - Security
**Duración:** ~5 min

---

## Resumen

Para bloquear IPs hay varias capas de defensa según tu arquitectura: NACL (deny rules, barato), Security Groups (solo allow), WAF (Layer 7), CloudFront Geo Restriction. La clave es entender el flujo del tráfico para saber dónde aplicar reglas.

---

## Escenario 1: EC2 en subred pública

```
Cliente
   │
   ▼
┌──────────────────────────────────────────────────┐
│  SUBRED PÚBLICA                                  │
│                                                  │
│  ┌─────────┐    ┌─────────────┐    ┌─────────┐  │
│  │  NACL   │───►│Security Group│───►│   EC2   │  │
│  │         │    │             │    │         │  │
│  │ DENY ✓  │    │ Solo ALLOW  │    │Firewall │  │
│  │ ALLOW ✓ │    │ (no deny)   │    │Software │  │
│  └─────────┘    └─────────────┘    └─────────┘  │
│                                                  │
│  1ra línea      2da línea         3ra línea     │
│  (más barata)   (solo allow)      (costo CPU)   │
└──────────────────────────────────────────────────┘
```

| Capa | Tipo de reglas | Costo | Notas |
|------|----------------|-------|-------|
| **NACL** | ALLOW + DENY | Barato | Primera línea, nivel subnet |
| **Security Group** | Solo ALLOW | Incluido | No tiene deny rules |
| **Firewall en EC2** | Custom | CPU cost | Control total pero consume recursos |

---

## Escenario 2: Con Application Load Balancer

```
Cliente
   │
   ▼
┌──────────────────────────────────────────────────┐
│  SUBRED PÚBLICA                                  │
│  ┌─────────┐    ┌─────────────┐                 │
│  │  NACL   │───►│     ALB     │                 │
│  │         │    │  + WAF ⭐   │                 │
│  └─────────┘    └──────┬──────┘                 │
└────────────────────────┼─────────────────────────┘
                         │ Connection termination
┌────────────────────────┼─────────────────────────┐
│  SUBRED PRIVADA        ▼                         │
│             ┌─────────────────┐                  │
│             │  Security Group │                  │
│             │  (allow from ALB)│                  │
│             └────────┬────────┘                  │
│                      ▼                           │
│                 ┌─────────┐                      │
│                 │   EC2   │                      │
│                 └─────────┘                      │
└──────────────────────────────────────────────────┘
```

**Connection Termination:** El cliente se conecta al ALB, y el ALB se conecta al EC2. Son conexiones separadas.

**Dónde bloquear IPs:**
1. **NACL** - reglas deny/allow a nivel subnet
2. **WAF en ALB** - IP filtering + más features (cuesta $)
3. **Security Group del EC2** - solo permite tráfico del ALB

---

## Escenario 3: Con CloudFront + ALB

```
Cliente
   │
   ▼
┌─────────────────┐
│   CloudFront    │◄── WAF (IP filtering)
│                 │◄── Geo Restriction (bloquear países)
└────────┬────────┘
         │ IPs públicas de CloudFront
         ▼
┌──────────────────────────────────────────────────┐
│  SUBRED PÚBLICA                                  │
│  ┌─────────┐    ┌─────────────┐                 │
│  │  NACL   │    │     ALB     │                 │
│  │  (NO    │───►│  SG: allow  │                 │
│  │  útil)  │    │  CloudFront │                 │
│  └─────────┘    │  IPs only   │                 │
│                 └──────┬──────┘                 │
└────────────────────────┼─────────────────────────┘
                         ▼
                       EC2
```

**IMPORTANTE:** Con CloudFront, el NACL NO sirve para filtrar clientes porque el tráfico viene de IPs de CloudFront, no del cliente.

**Dónde bloquear:**
1. **CloudFront Geo Restriction** - bloquear países
2. **WAF en CloudFront** - IP filtering del cliente real
3. **Security Group del ALB** - solo permitir IPs de CloudFront

---

## Resumen: Dónde bloquear según arquitectura

| Arquitectura | Dónde bloquear IP del cliente |
|--------------|-------------------------------|
| EC2 directo | NACL (deny rule) |
| ALB → EC2 | NACL o WAF en ALB |
| CloudFront → ALB → EC2 | WAF en CloudFront o Geo Restriction |

---

## Puntos Clave para el Examen

1. **NACL** = tiene DENY rules, Security Group = solo ALLOW
2. **WAF** = IP filtering a nivel ALB o CloudFront
3. **CloudFront** invalida NACL para filtrar clientes (tráfico viene de CF, no del cliente)
4. **Geo Restriction** en CloudFront para bloquear países
5. **Siempre dibuja el flujo** para entender dónde aplicar reglas

